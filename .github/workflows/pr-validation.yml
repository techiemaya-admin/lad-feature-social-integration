  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # ------------------------------------------------------------
      # LAD BLOCKER REPORT INIT
      # ------------------------------------------------------------
      - name: Init LAD Report
        run: |
          echo "HAS_BLOCKERS=false" >> $GITHUB_ENV
          echo "LAD_REPORT<<'EOF'" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "" > lad_blockers_report.md

      # ------------------------------------------------------------
      # üî¥ LAD Rule #1: Hardcoded schema (lad_dev.)
      # ------------------------------------------------------------
      - name: LAD Rule #1 - Hardcoded schema names (lad_dev.)
        continue-on-error: true
        run: |
          echo "Checking for hardcoded schema names (lad_dev.)..."
          set +e
          matches=$(grep -RIn \
            --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
            -E "(^|[^a-zA-Z0-9_])lad_dev\." backend frontend migrations 2>/dev/null | wc -l)
          set -e

          if [ "$matches" -gt 0 ]; then
            echo "HAS_BLOCKERS=true" >> $GITHUB_ENV
            {
              echo "## üî¥ CRITICAL BLOCKERS (Cannot Deploy):"
              echo ""
              echo "### Issue #1: Hardcoded Schema Names"
              echo ""
              echo "**Found:** ${matches}+ instances of \`lad_dev.table_name\` in SQL queries"
              echo "**Impact:** Breaks multi-tenancy ‚Äî works only for lad_dev, fails for real tenant schemas"
              echo "**Fix Required:** Replace hardcoded schema with \`\${getSchema(req)}.table_name\` (or schemaHelper equivalent)"
              echo ""
              echo "**Examples (first 30):**"
              echo '```'
              grep -RIn \
                --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
                -E "(^|[^a-zA-Z0-9_])lad_dev\." backend frontend migrations 2>/dev/null | head -n 30
              echo '```'
              echo ""
            } >> lad_blockers_report.md
          fi

      # ------------------------------------------------------------
      # üî¥ LAD Rule #2: console.* statements
      # ------------------------------------------------------------
      - name: LAD Rule #2 - console.log/error/warn/info/debug forbidden
        continue-on-error: true
        run: |
          echo "Checking for console.* usage..."
          set +e
          matches=$(grep -RIn \
            --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
            --exclude="*.test.*" --exclude="*.spec.*" \
            -E "\bconsole\.(log|error|warn|info|debug)\b" backend frontend 2>/dev/null | wc -l)
          set -e

          if [ "$matches" -gt 0 ]; then
            echo "HAS_BLOCKERS=true" >> $GITHUB_ENV
            {
              echo "### Issue #2: Console.log Statements"
              echo ""
              echo "**Found:** ${matches}+ console statements"
              echo "**Impact:** Performance degradation, potential security leaks, no log control"
              echo "**Fix Required:** Replace with \`logger.info/warn/error/debug\`"
              echo ""
              echo "**Examples (first 30):**"
              echo '```'
              grep -RIn \
                --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
                --exclude="*.test.*" --exclude="*.spec.*" \
                -E "\bconsole\.(log|error|warn|info|debug)\b" backend frontend 2>/dev/null | head -n 30
              echo '```'
              echo ""
            } >> lad_blockers_report.md
          fi

      # ------------------------------------------------------------
      # üî¥ LAD Rule #3: fetch() in web layer (SDK-first)
      # ------------------------------------------------------------
      - name: LAD Rule #3 - No fetch() in frontend/web/src
        continue-on-error: true
        run: |
          echo "Checking for fetch() usage in web layer..."
          if [ -d "frontend/web/src" ]; then
            set +e
            matches=$(grep -RIn \
              --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
              -E "\bfetch\(" frontend/web/src 2>/dev/null | wc -l)
            set -e

            if [ "$matches" -gt 0 ]; then
              echo "HAS_BLOCKERS=true" >> $GITHUB_ENV
              {
                echo "### Issue #3: Direct fetch() Calls in Web Layer"
                echo ""
                echo "**Found:** ${matches}+ direct fetch() calls in \`frontend/web/src\`"
                echo "**Impact:** Breaks SDK-first rule ‚Äî web layer must remain thin"
                echo "**Fix Required:** Move HTTP calls into \`frontend/sdk/features/<feature>/api.ts\` + consume via hooks"
                echo ""
                echo "**Examples (first 30):**"
                echo '```'
                grep -RIn \
                  --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
                  -E "\bfetch\(" frontend/web/src 2>/dev/null | head -n 30
                echo '```'
                echo ""
              } >> lad_blockers_report.md
            fi
          fi

      # ------------------------------------------------------------
      # üî¥ LAD Rule #4: node_modules inside SDK
      # ------------------------------------------------------------
      - name: LAD Rule #4 - No node_modules in frontend/sdk
        continue-on-error: true
        run: |
          echo "Checking for frontend/sdk/node_modules..."
          if [ -d "frontend/sdk/node_modules" ]; then
            echo "HAS_BLOCKERS=true" >> $GITHUB_ENV
            {
              echo "### Issue #4: node_modules inside SDK"
              echo ""
              echo "**Found:** \`frontend/sdk/node_modules\` exists"
              echo "**Impact:** Bloats repo, breaks workspace dependency model"
              echo "**Fix Required:** Remove it and ensure it is gitignored; SDK must rely on workspace deps"
              echo ""
            } >> lad_blockers_report.md
          fi

      # ------------------------------------------------------------
      # üî¥ LAD Rule #5: duplicate DB connection / pool creation in feature repos
      # ------------------------------------------------------------
      - name: LAD Rule #5 - No new Pool() in backend/features
        continue-on-error: true
        run: |
          echo "Checking for duplicate DB pool creation in backend/features..."
          if [ -d "backend/features" ]; then
            set +e
            matches=$(grep -RIn \
              --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
              -E "new\s+Pool\(|pg\.Pool\(|createPool\(" backend/features 2>/dev/null | wc -l)
            set -e

            if [ "$matches" -gt 0 ]; then
              echo "HAS_BLOCKERS=true" >> $GITHUB_ENV
              {
                echo "### Issue #5: Duplicate DB Connection / Pool Creation"
                echo ""
                echo "**Found:** ${matches}+ potential DB pool creations in feature code"
                echo "**Impact:** Breaks shared connection rule; causes inconsistent pooling, env drift"
                echo "**Fix Required:** Import connection from \`backend/shared/database/connection.js\` (or approved resolver helper)"
                echo ""
                echo "**Examples (first 30):**"
                echo '```'
                grep -RIn \
                  --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=build \
                  -E "new\s+Pool\(|pg\.Pool\(|createPool\(" backend/features 2>/dev/null | head -n 30
                echo '```'
                echo ""
              } >> lad_blockers_report.md
            fi
          fi

      # ------------------------------------------------------------
      # Post comment if blockers exist
      # ------------------------------------------------------------
      - name: Comment LAD blockers on PR
        if: env.HAS_BLOCKERS == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('lad_blockers_report.md', 'utf8').trim();

            // avoid empty comment
            const finalBody = body.length ? body : "## üî¥ CRITICAL BLOCKERS\n\n(Report was empty but HAS_BLOCKERS=true)";

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: finalBody,
            });

      # ------------------------------------------------------------
      # Fail build if blockers exist
      # ------------------------------------------------------------
      - name: Fail if LAD blockers exist
        if: env.HAS_BLOCKERS == 'true'
        run: |
          echo "‚ùå LAD blockers detected. See PR comment for details."
          exit 1
